{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.client_name }} - Photo Selection{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/selection.css' %}">
{% endblock %}

{% block content %}

<div class="selection-header">
    <h2>{{ project.client_name }} - Select Your Photos</h2>

    <div class="selection-counter">
        Selected: <span id="selected-count">0</span>
    </div>

    <button id="save-selection" class="save-btn">
        Save Selection
    </button>
</div>

<div class="gallery-container">
    {% for photo in photos %}
        <div class="photo-card {% if photo.is_selected %}selected{% endif %}"
             data-photo-id="{{ photo.id }}">
             
            <img src="{{ photo.image.url }}" alt="Photo">
            <div class="overlay">âœ“ Selected</div>
        </div>
    {% empty %}
        <p class="empty-text">No photos available for selection.</p>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
/* =========================
   CSRF HELPER
========================= */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(
                    cookie.substring(name.length + 1)
                );
            }
        });
    }
    return cookieValue;
}

/* =========================
   SELECTION TOGGLE
========================= */
document.addEventListener("DOMContentLoaded", function () {

    const photoCards = document.querySelectorAll(".photo-card");
    const saveBtn = document.getElementById("save-selection");
    const counter = document.getElementById("selected-count");

    function updateCounter() {
        const count = document.querySelectorAll(".photo-card.selected").length;
        counter.innerText = count;
    }

    photoCards.forEach(card => {
        card.addEventListener("click", function () {
            this.classList.toggle("selected");
            updateCounter();
        });
    });

    // Initialize counter on load
    updateCounter();

    /* =========================
       AJAX SAVE
    ========================= */
    saveBtn.addEventListener("click", function () {

        const selectedIds = Array.from(
            document.querySelectorAll(".photo-card.selected")
        ).map(el => el.dataset.photoId);

        fetch("{% url 'projects:save_client_selection' token=project.selection.token %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({
                selected_ids: selectedIds
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Your selection has been saved!");
            } else {
                alert("Error saving selection: " + (data.error || "Unknown error"));
            }
        })
        .catch(error => {
            alert("Network error: " + error);
        });

    });

});
</script>
{% endblock %}
