{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/project_sessions.css' %}">
{% endblock %}

{% block title %}Project Sessions{% endblock %}

{% block content %}
<div class="page-container">

  <!-- Tabs -->
  <section class="tabs">
    <div class="tab active">Upcoming Event</div>
    <div class="tab">Past Event</div>
    <div class="tab">To be decided</div>
  </section>

  <!-- Project Details -->
  <section class="project-details">
    <h2 class="event-name">
      {% if request.user.is_staff %}
        <input type="text" value="{{ project.client_name }}"
               data-field="client_name" data-project-id="{{ project.id }}" />
        <input type="text" value="{{ project.event_type }}"
               data-field="event_type" data-project-id="{{ project.id }}" />
      {% else %}
        {{ project.client_name }} – {{ project.event_type }}
      {% endif %}
    </h2>

    <div class="detail-row"><strong>Venue:</strong>
      {% if request.user.is_staff %}
        <input type="text" value="{{ project.venue|default:'' }}"
               data-field="venue" data-project-id="{{ project.id }}" />
      {% else %}
        {{ project.venue|default:'N/A' }}
      {% endif %}
    </div>

    <div class="detail-row"><strong>Time:</strong>
      {% if request.user.is_staff %}
        <input type="time" value="{{ project.time|time:'H:i'|default:'' }}"
               data-field="time" data-project-id="{{ project.id }}" />
      {% else %}
        {{ project.time|time:"H:i"|default:'N/A' }}
      {% endif %}
    </div>

    <div class="detail-row"><strong>Duration:</strong>
      {% if request.user.is_staff %}
        <input type="text" value="{{ project.duration|default:'' }}"
               data-field="duration" data-project-id="{{ project.id }}" />
      {% else %}
        {{ project.duration|default:'N/A' }}
      {% endif %}
    </div>

    <div class="detail-row"><strong>Dates:</strong>
      {% if request.user.is_staff %}
        <input type="date" value="{{ project.start_date|date:'Y-m-d' }}"
               data-field="start_date" data-project-id="{{ project.id }}" /> — 
        <input type="date" value="{{ project.end_date|date:'Y-m-d' }}"
               data-field="end_date" data-project-id="{{ project.id }}" />
      {% else %}
        {{ project.start_date|date:"d/m/Y"|default:'N/A' }} — {{ project.end_date|date:"d/m/Y"|default:'N/A' }}
      {% endif %}
    </div>

    {% if request.user.is_staff %}
      <button id="save-project" class="btn btn-primary">Save Changes</button>
    {% endif %}
  </section>

  <!-- Team Members -->
  <section class="team-members">
    <h3>Team Members</h3>

    {% with pre_roles=pre_roles post_roles=post_roles %}

    <!-- General -->
    <div class="team-group">
      <h4>General</h4>
      <div class="avatars">
        {% for member in users %}
          {% if not member.photography_role %}
            <div class="avatar {% if member in project.team.all %}active{% endif %}"
                 {% if request.user.is_staff %}
                   data-user-id="{{ member.id }}" data-project-id="{{ project.id }}"
                 {% endif %}
                 title="{{ member.username }}">
              {{ member.username|slice:":2"|upper }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Pre Production -->
    <div class="team-group">
      <h4>Pre Production</h4>
      <div class="avatars">
        {% for member in users %}
          {% if member.photography_role in pre_roles %}
            <div class="avatar {% if member in project.team.all %}active{% endif %}"
                 {% if request.user.is_staff %}
                   data-user-id="{{ member.id }}" data-project-id="{{ project.id }}"
                 {% endif %}
                 title="{{ member.username }}">
              {{ member.username|slice:":2"|upper }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    <!-- Selection -->
<div class="team-group">
  <h4>Selection</h4>

  <!-- Team Avatars -->
  <div class="avatars">
    {% for member in users %}
      {% if member.photography_role == "selection" %}
        <div class="avatar {% if member in project.team.all %}active{% endif %}"
             {% if request.user.is_staff %}
               data-user-id="{{ member.id }}" data-project-id="{{ project.id }}"
             {% endif %}
             title="{{ member.username }}">
          {{ member.username|slice:":2"|upper }}
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Client Selection Link -->
  <!-- Client Selection Link -->
    {% if project.status == "selection" and project.selection %}
    <div style="margin-top:15px;">
        <a href="{% url 'projects:client_selection' project.selection.token %}"
          class="selection-link-btn">
          Open Client Selection Page
        </a>
    </div>
    {% endif %}
    


</div>


    <!-- Post Production -->
    <div class="team-group">
      <h4>Post Production</h4>
      <div class="avatars">
        {% for member in users %}
          {% if member.photography_role in post_roles %}
            <div class="avatar {% if member in project.team.all %}active{% endif %}"
                 {% if request.user.is_staff %}
                   data-user-id="{{ member.id }}" data-project-id="{{ project.id }}"
                 {% endif %}
                 title="{{ member.username }}">
              {{ member.username|slice:":2"|upper }}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    {% endwith %}
  </section>

  <!-- Tasks -->
  <section class="tasks">
    {% for stage, tasks in tasks_by_stage %}
      {% if tasks %}
        <h3>{{ stage }} Tasks</h3>
        <ul>
          {% for task in tasks %}
            <li>
              {% if request.user.is_staff %}
                <input type="checkbox" class="task-toggle"
                       data-task-id="{{ task.id }}"
                       {% if task.is_completed %}checked{% endif %}>
                {{ task.title }}
              {% else %}
                {{ task.title }} {% if task.is_completed %}(✓){% endif %}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endfor %}
  </section>

  <!-- Due Date + Notifications -->
  <section class="actions">
    <label for="due-date">Add Due Date*</label>
    {% if request.user.is_staff %}
      <input type="date" id="due-date" name="due-date"
             value="{{ project.due_date|date:'Y-m-d'|default:'' }}"
             data-field="due_date" data-project-id="{{ project.id }}">
      <button id="send-notifications" class="btn btn-danger"
              data-project-id="{{ project.id }}">Send Notifications</button>
    {% else %}
      {{ project.due_date|date:"d/m/Y"|default:'N/A' }}
    {% endif %}
  </section>

</div>

{% block extra_js %}
<script src="{% static 'js/project_sessions.js' %}"></script>
{% endblock %}
{% endblock %}
